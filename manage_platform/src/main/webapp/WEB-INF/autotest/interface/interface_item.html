<!DOCTYPE html>
<html lang="en">

<head>
    <!-- fileinput -->
    <link href="../../vendor/bootstrap-fileinput/css/fileinput.min.css" rel="stylesheet" type="text/css">

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
    <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>

     <!-- fileinput -->
    <script src="../../vendor/bootstrap-fileinput/js/fileinput.min.js"></script>
    <script src="../../vendor/bootstrap-fileinput/js/fileinput_locale_zh.js"></script>


</head>

<body>
<div class="panel-heading">
    <ol class="breadcrumb">
        <li><a href="#">接口自动化</a></li>
        <li><a href="#">接口管理</a></li>
        <li class="active">新增测试集</li>
    </ol>
</div>
<div class="col-lg-14">
    <div class="panel panel-default">

        <div class="panel-body">
            <!-- 计划基本配置 -->
            <form role="form " class="col-lg-12 edit-form" id="interface-form" enctype="multipart/form-data">
                <div class="col-lg-12 form-div-interface">
                    <div class="form-group">
                        <label class="control-label">接口ID</label>
                        <input type="text" class="form-control" id="interfaceId" name="id" placeholder="保存之后自动填充"
                               value="${interfaceDto.id}" readonly>
                    </div>
                    <div class="form-group">
                        <label class="control-label">接口名</label>
                        <input type="text" class="form-control" id="interfaceName" name="name" placeholder="请填写接口名称"
                               value="${interfaceDto.name}">
                    </div>
                    <div class="form-group">
                        <label class="control-label">接口描述</label>
                        <input type="text" class="form-control" id="interfaceDesc" name="description"
                               placeholder="描述接口功能或业务特性" value="${interfaceDto.description}">
                    </div>
                    <!--所属service-->
                    <div class="form-group ">
                        <label>所属service</label>
                        <select class="form-control col-lg-5" name="serviceId">
                            <option value=""
                            <#if interfaceDto.serviceId=null>disabled selected</#if>
                            >选择服务名称</option>
                            <#if serviceList ??>
                                <#list serviceList as item>
                                    <option value="${item.id}"
                                    <#if interfaceDto.serviceId=item.id>selected</#if>
                                    >${item.name}</option>
                                </#list>
                            </#if>
                        </select>
                    </div>
                    <!--接口类型-->
                    <div class="form-group">
                        <label>接口类型</label>
                        <#if interfaceTypeEnumList??>
                            <#list interfaceTypeEnumList as item>
                                <label class="radio-inline" style="margin-top: 0">
                                    <input type="radio" name="type" value="${item.getId()}"
                                    <#if interfaceDto.type=item.getId() || (interfaceDto.type=null && item.getId()=1)>
                                        checked="true"
                                    </#if>
                                    >${item.getName()}
                                </label>
                            </#list>
                        </#if>
                    </div>

                    <!--dubbo接口-->
                    <div class="form-group dubbo-interface hidden">
                        <label class="control-label" for="zkOrNot">调用方式</label>
                        <select class="form-control" id="zkOrNot" name="zkOrNot">
                            <option value="1"
                            <#if interfaceDto.zkOrNot=1>selected</#if>
                            >通过zookeeper注册中心</option>
                            <option value="0"
                            <#if interfaceDto.zkOrNot=0>selected</#if>
                            >不通过zookeeper注册中心</option>
                        </select>
                    </div>
                    <div class="form-group dubbo-interface hidden">
                        <label class="control-label">版本</label>
                        <input type="text" class="form-control" id="dubboVersion" name="dubboVersion"
                               value="${interfaceDto.dubboVersion}">
                    </div>
                    <div class="form-group dubbo-interface hidden">
                        <label class="control-label">分组</label>
                        <input type="text" class="form-control" id="dubboGroup" name="dubboGroup">
                    </div>
                    <div class="form-group dubbo-interface hidden">
                        <label class="control-label">超时</label>
                        <input type="text" class="form-control" id="dubboTimeout" name="dubboTimeout">
                    </div>

                    <!--http接口-->
                    <div class="form-group http-interface ">
                        <label class="control-label">请求路径</label>
                        <input type="text" class="form-control" id="urlPath" name="url">
                    </div>
                    <div class="form-group http-interface ">
                        <label class="control-label">参数名</label>
                        <input type="text" class="form-control" id="param" name="param" placeholder="多个参数用“，”隔开">
                    </div>
                    <div class="form-group http-interface ">
                        <label class="control-label">协议类型</label>
                        <select class="form-control" id="protocolType" name="protocolType">
                            <#if httpTypeList ??>
                                <#list httpTypeList as item>
                                    <option value="${item.getId()}"
                                    <#if interfaceDto.protocolType = item.getId()></#if>
                                    >${item.getName()}
                                    </option>
                                </#list>
                            </#if>
                        </select>
                    </div>
                    <div class="form-group http-interface ">
                        <label class="control-label">请求方式</label>
                        <select class="form-control" id="requestType"
                                name="requestType">
                            <#if requestTypeList ??>
                                <#list requestTypeList as item>
                                    <option value="${item.getId()}"
                                    <#if interfaceDto.requestType = item.getId()></#if>
                                    >${item.getName()}
                                    </option>
                                </#list>
                            </#if>
                        </select>
                    </div>
                    <div class="form-group http-interface ">
                        <label class="control-label">Content-Type</label>
                        <select class="form-control" id="contentType"
                                name="contentType">
                            <#if contentTypeList ??>
                                <#list contentTypeList as item>
                                    <option value="${item.getId()}">${item.getName()}
                                    </option>
                                </#list>
                            </#if>
                        </select>
                    </div>

                    <div class="form-group ">
                        <label class="control-label">加密jar包</label>
                        <!--<input id="file-0" class="file form-control" type="file" multiple data-min-file-count="1" name="file">-->
                        <input id="file-0" type="file" multiple class="file" data-overwrite-initial="false"
                               data-min-file-count="1" name="file">
                        <input type="hidden" name="jarPath">
                    </div>
                    <div class="form-group ">
                        <label class="control-label">编写调用代码</label>
                        <textarea type="text" class="form-control" name="codeText"
                                  placeholder="调用jar包内加密算法的demo"></textarea>
                    </div>

                    <div class="form-group btn-div">
                        <button type="submit" class="btn btn-primary interface-submit">保存</button>
                        <button type="button" data-toggle="modal" data-target="#dataPrepare" class="btn btn-info interface-prepare" onclick="showDataPrepare()">数据准备
                        </button>
                        <button type="button" data-toggle="modal" data-target="#dataPrepare" class="btn btn-warning interface-clear" onclick="showDataClear()">数据清除
                        </button>
                        <button type="button" class="btn btn-success interface-reset">重置</button>
                    </div>
                </div>
            </form>
        </div>

        <!-- 数据准备弹框 -->
        <div class="modal fade" id="dataPrepare" tabindex="-1" role="dialog" aria-labelledby="dataPrepareLabel"
             aria-hidden="true">
            <div class="modal-dialog ">
                <div class="modal-content">
                    <div class="modal-header">
                        <input type="hidden" name="operateType" id="operateType" value="${operateType}">
                        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                        <h4 class="modal-title" id="dataPrepareLabel">
                            <#if operateType=1>数据准备</#if>
                            <#if operateType=1>数据清除</#if>
                        </h4>
                    </div>
                    <div class="modal-body">
                        <div class="panel panel-default operation">
                            <div class="panel-heading">
                                数据库操作
                            </div>
                            <div class="panel-body">
                                <div class="table-responsive">
                                    <table class="table case-table">
                                        <thead>
                                        <tr>
                                            <th style="width: 15%">数据库配置名</th>
                                            <th style="width: 75%">sql语句</th>
                                            <th>操作</th>
                                            <th></th>
                                        </tr>
                                        </thead>
                                        <tbody>
                                        <#if testDatabaseConfigDtoList??>
                                            <#list testDatabaseConfigDtoList as relationItem>
                                                <tr>
                                                    <div class="row">
                                                        <td>

                                                            <input type="hidden" name="id" value="${id}">
                                                            <select class="form-control" name="databaseId">
                                                                <#if databaseConfigDtoList ??>
                                                                    <#list databaseConfigDtoList as item>
                                                                        <option value="${item.id}">${item.name}</option>
                                                                    </#list>
                                                                </#if>
                                                            </select>
                                                        </td>
                                                        <td><textarea type="text" class="form-control"
                                                                     name="sqlStr" style="height: 34px;resize: vertical;width: 100%"></textarea>
                                                        </td>
                                                        <td>
                                                            <button type="submit" class="btn btn-info"
                                                                    onclick="addDatabaseSql(this)">保存
                                                            </button>
                                                        </td>
                                                        <td>
                                                            <button type="button" name="delete" class="btn btn-info">
                                                                删除
                                                            </button>
                                                        </td>
                                                    </div>
                                                </tr>
                                                </tr>
                                            </#list>
                                        </#if>
                                        <tr>
                                            <td style=" border: none"><span id="prepareAddDbOperation"
                                                                            class="btn btn-info"><i
                                                    class="icon icon-plus-sign"></i>添加数据库操作</span></td>
                                        </tr>
                                        </tbody>
                                    </table>
                                </div>
                                <!-- /.table-responsive -->
                            </div>
                            <!-- /.panel-body -->
                        </div>
                        <div class="panel panel-default operation">
                            <div class="panel-heading">
                                redis操作
                            </div>
                            <div class="panel-body">
                                <div class="table-responsive">
                                    <table class="table case-table">
                                        <thead>
                                        <tr>
                                            <th style="width: 10%">redis名</th>
                                            <th style="width: 10%">redis操作类型</th>
                                            <th style="width: 30%">key</th>
                                            <th style="width: 30%">value</th>
                                            <th style="width: 10%">time</th>
                                            <th>操作</th>
                                            <th></th>
                                        </tr>
                                        </thead>
                                        <tbody>
                                        <#if testDatabaseConfigDtoList??>
                                            <#list testDatabaseConfigDtoList as relationItem>
                                                <tr>
                                                    <div class="row">
                                                        <td>
                                                            <input type="hidden" name="id" value="${id}">
                                                            <select class="form-control" name="redisId">
                                                                <#if testRedisConfigDtoList ??>
                                                                    <#list testRedisConfigDtoList as item>
                                                                        <option value="${item.id}"> ${item.name}
                                                                        </option>
                                                                    </#list>
                                                                </#if>
                                                            </select>
                                                        </td>
                                                        <td>
                                                            <select class="form-control case-select" id="redisOperateType"
                                                                    name="redisOperateType">
                                                                <#if redisOperationTypeEnumList ??>
                                                                    <#list redisOperationTypeEnumList as item>
                                                                        <option value="${item.getName()}">
                                                                            ${item.getName()}
                                                                        </option>
                                                                    </#list>
                                                                </#if>
                                                            </select>
                                                        </td>
                                                        <td><input type="text" class="form-control" name="key"></td>
                                                        <td><input type="text" class="form-control" name="value"></td>
                                                        <td><input type="text" class="form-control" name="time"></td>

                                                        <td>
                                                            <button type="submit" class="btn btn-info"
                                                                    onclick="addRedisOperation(this)">保存
                                                            </button>
                                                        </td>
                                                        <td>
                                                            <button type="button" name="delete" class="btn btn-info">
                                                                删除
                                                            </button>
                                                        </td>
                                                    </div>
                                                </tr>
                                                </tr>
                                            </#list>
                                        </#if>
                                        <tr>
                                            <td style=" border: none"><span id="prepareAddRedisOperation"
                                                                            class="btn btn-info"><i
                                                    class="icon icon-plus-sign"></i>添加redis操作</span></td>
                                        </tr>
                                        </tbody>
                                    </table>
                                </div>
                                <!-- /.table-responsive -->
                            </div>
                            <!-- /.panel-body -->
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-primary">保存</button>
                        <button type="button" class="btn btn-default" data-dismiss="modal">关闭</button>
                    </div>
                </div>
                <!-- /.modal-content -->
            </div>
            <!-- /.modal-dialog -->
        </div>
    </div>
</div>

<!-- /.container-fluid -->
<script type="text/javascript">
    var dbhtml = '<td><input type="hidden" name="id">';
    dbhtml += '<select class="form-control" name="databaseId">';
    dbhtml += '<#if databaseConfigDtoList ??>';
    dbhtml += '<#list databaseConfigDtoList as item>';
    dbhtml += '<option value="${item.id}">${item.name} </option>';
    dbhtml += '</#list>';
    dbhtml += '</#if>';
    dbhtml += '</select>';
    dbhtml += '</td>';
    dbhtml += '<td><textarea type="text" name="sqlStr" class="form-control" style="height: 34px;resize: vertical;width: 100%"></textarea></td>';
    dbhtml += '<td>';
    dbhtml += '<button type="submit" class="btn btn-info" onclick="addDatabaseSql(this)">保存</button>';
    dbhtml += '</td>';
    dbhtml += '<td>';
    dbhtml += '<button type="button" name="delete" class="btn btn-info">删除</button>';
    dbhtml += '</td>';
    dbhtml += '</form>';
    dbhtml += '</tr>';

    var redishtml = '<td><input type="hidden" name="id">';
    redishtml += '<select class="form-control"  name="redisId">';
    redishtml += '<#if testRedisConfigDtoList ??>';
    redishtml += '<#list testRedisConfigDtoList as item>';
    redishtml += '<option value="${item.id}"> ${item.name} </option>';
    redishtml += '</#list>';
    redishtml += '</#if>';
    redishtml += '</select>';
    redishtml += '</td>';
    redishtml += '<td>';
    redishtml += '<select class="form-control case-select" id="redisOperateType" name="redisOperateType">';
    redishtml += '<#if redisOperationTypeEnumList ??>';
    redishtml += '<#list redisOperationTypeEnumList as item>';
    redishtml += '<option value="${item.getId()}"> ${item.getName()} </option>';
    redishtml += '</#list>';
    redishtml += '</#if>';
    redishtml += '</select>';
    redishtml += '</td>';
    redishtml += '<td><input type="text" class="form-control" name="key"></td>';
    redishtml += '<td><input type="text" class="form-control" name="value"></td>';
    redishtml += '<td><input type="text" class="form-control" name="time" placeholder="ms数"></td>';
    redishtml += '<td>';
    redishtml += '<button type="submit" class="btn btn-info"  onclick="addRedisOperation(this)">保存</button>';
    redishtml += '</td>';
    redishtml += '<td>';
    redishtml += '<button type="button" name="delete" class="btn btn-info">删除</button>';
    redishtml += '</td>';
    redishtml += '</form>';
    redishtml += '</tr>';

    //显示数据准备
    function showDataPrepare(){
        $("#dataPrepareLabel").text("数据准备");
        $("#operateType").val(1);
    }

    //显示数据清除
    function showDataClear(){
        $("#dataPrepareLabel").text("数据清除");
        $("#operateType").val(2);
    }

    var dbCount = 0;
    $("#prepareAddDbOperation").click(function () {
        var htmlStr = '<tr>';
        htmlStr += '<form class="row" id="databaseForm' + dbCount + '">';
        htmlStr += dbhtml;
        $(this).parent().parent().before(htmlStr);
        dbCount += 1;
        $("button[name='delete']").click(function () {
            $(this).parent().parent().remove();
        })
    });

    var redisCount = 0;
    $("#prepareAddRedisOperation").click(function () {
        var htmlStr = '<tr>';
        htmlStr += '<form class="row" id="redisForm' + redisCount + '">';
        htmlStr += redishtml;
        $(this).parent().parent().before(htmlStr);
        redisCount += 1;
        $("button[name='delete']").click(function () {
            $(this).parent().parent().remove();
        })

        $("select[name='redisOperateType']").change(function () {
            var content = $(this).val();
            var value;
            var time;
            if (content == 'del') {
                value = $(this).parent().next().next().children()[0];
                value.setAttribute("readOnly", "true");
                value.setAttribute("placeholder", "不需要填");
                time = $(this).parent().next().next().next().children()[0];
                time.setAttribute("readOnly", "true");
                time.setAttribute("placeholder", "不需要填");
            } else if (content == 'set') {
                value = $(this).parent().next().next().children()[0];
                value.removeAttribute("readOnly");
                value.removeAttribute("placeholder");
                time = $(this).parent().next().next().next().children()[0];
                time.removeAttribute("readOnly");
                time.removeAttribute("placeholder");
            } else if (content == 'expire') {
                value = $(this).parent().next().next().children()[0];
                value.setAttribute("readOnly", "true");
                value.setAttribute("placeholder", "不需要填");
                time = $(this).parent().next().next().next().children()[0];
                time.removeAttribute("readOnly");
                time.removeAttribute("placeholder");
            }

        })
    });


    $(".radio-inline").change(
            function () {
                var value = $("input[name='type']:checked").val();
                if (value == "2") {
                    $(".dubbo-interface").removeClass("hidden");
                    $(".http-interface").addClass("hidden");
                }
                else if (value == "1") {
                    $(".http-interface").removeClass("hidden");
                    $(".dubbo-interface").addClass("hidden");
                }
            }
    );

    //初始化fileinput控件（第一次初始化）
    $("#file-0").fileinput({
        showUpload: false,
        uploadAsync: true,
        uploadUrl: '${basePath}/autotest/interface-jar/uploadJar', // you must set a valid URL here else you will get an error
        allowedFileExtensions: ['jar', 'war'],
        overwriteInitial: false,
        language: 'zh', //设置语言
        maxFileSize: 200000,
        maxFilesNum: 1,
        showPreview: true,
        previewFileIcon: "",
        slugCallback: function (filename) {
            return filename.replace('(', '_').replace(']', '_');
        }
    }).on("filebatchselected", function (event, files) {
        $(this).fileinput("upload").on("fileuploaded", function (event, data) {
            if (data.response.code == 0) {
                $("input[name='jarPath']").val(data.response.data);
            } else {
                alert("上传失败:" + data.response.message);
            }

        });
    });

    $(document).ready(function () {
        $("#interface-form").validate({
            submitHandler: function () {  //验证通过后的执行方法
                //当前的form通过ajax方式提交（用到jQuery.Form文件）
                $.ajax({
                    type: "POST",
                    dataType: "html",
                    url: "${basePath}/autotest/interface/saveInterface",
                    data: $('#interface-form').serialize(),
                    success: function (result) {
                        data = eval("(" + result + ")");
                        if (data.code == 0) {
                            // $("#addService").modal("hide");
                            alert("保存成功");
                            $("#interface-form input[name='id']").val(data.data.id);
                        } else {
                            alert("保存失败：" + data.message);
                        }
                    },
                    error: function (result) {
                        alert(eval("(" + result + ")").message);
                    }
                });
            },
            focusInvalid: true,   //验证提示时，鼠标光标指向提示的input
            rules: {
                name: {
                    required: true,
                    maxlength: 30
                },
                description: {
                    maxlength: 300
                },
                serviceId: {
                    required: true
                },
                type: {
                    required: true
                },
                url: {
                    required: true,
                    maxlength: 300
                }
            },
            messages: {
                name: {
                    required: "请输入接口名称",
                    maxlength: "接口名称不超过30个字符"
                },
                description: {
                    maxlength: "接口描述不超过300个字符"
                },
                serviceId: {
                    required: "请选择接口所属服务"
                },
                type: {
                    required: "请选择接口类型"
                },
                url: {
                    required: "请输入接口路径",
                    maxlength: "接口路径不超过300个字符"
                }
            },
            errorElement: "span",
            errorClass: "error_info",
            showErrors: function (errorMap, errorList) {
                $.each(this.successList, function (index, value) {
                    return $(value).popover("hide");
                });
                return $.each(errorList, function (index, value) {
                    var _popover;
                    _popover = $(value.element).popover({
                        trigger: "manual",
                        placement: "top",
                        content: value.message,
                        template: "<div class=\"popover\"> <div class=\"arrow\"></div> <div class=\"popover-inner\"> <div class=\"popover-content\"><p></p></div> </div></div>"
                    });
                    _popover.data("bs.popover").options.content = value.message;
                    return _popover.popover("show");
                });
            }

        });
    });

    function getDatabaseData(_this){
        var databaseId = $(_this).parent().parent().find("select[name='databaseId']").val();
        var sqlStr = $(_this).parent().parent().find("textarea[name='sqlStr']").val();
        var id  = $(_this).parent().parent().find("input[name='id']").val();
        var operateType = $("#operateType").val();
        var interfaceId = $("#interface-form input[name='id']").val();
        //表示是接口数据处理
        var type = 1;
        var params = "databaseId=" + databaseId + "&sqlStr=" + sqlStr + "&id=" + id + "&operateType=" + operateType + "&type=" + type +"&interfaceId=" + interfaceId;
        return params;

    }
    function addDatabaseSql(_this) {
        var params = getDatabaseData(_this);
        $.ajax({
            type: "POST",
            url: "${basePath}/autotest/interface/saveDataBaseSql",
            data: params,
            success: function (result) {
                if (result.code == 0) {
                    data = result.data;
                    alert("保存成功");
                    $(_this).parent().parent().find("input[name='id']").val(data.id);
                } else {
                    alert("保存失败：" + result.message);
                }
            },
            error: function (result) {
                alert(result.message);
            }
        });

    }

    function getRedisData(_this){
        var redisId = $(_this).parent().parent().find("select[name='redisId']").val();
        var redisOperateType = $(_this).parent().parent().find("select[name='redisOperateType']").val();
        var id  = $(_this).parent().parent().find("input[name='id']").val();
        var operateType =  $("#operateType").val();
        var key = $(_this).parent().parent().find("input[name='key']").val();
        var value = $(_this).parent().parent().find("input[name='value']").val();
        var time = $(_this).parent().parent().find("input[name='time']").val();
        var interfaceId = $("#interface-form input[name='id']").val();
        //表示是接口数据处理
        var type = 1;
        var params = "redisId=" + redisId + "&redisOperateType=" + redisOperateType;
        params += "&id=" + id + "&operateType=" + operateType + "&type=" + type ;
        params += "&interfaceId=" + interfaceId + "&key=" + key + "&value=" + value + "&time=" + time;
        return params;
    }

    function addRedisOperation(_this) {
        var params = getRedisData(_this);
        $.ajax({
            type: "POST",
            url: "${basePath}/autotest/interface/saveRedisOperation",
            data: params,
            success: function (result) {
                if (result.code == 0) {
                    data = result.data;
                     alert("保存成功");
                    $(_this).parent().parent().find("input[name='id']").val(data.id);
                } else {
                    alert("保存失败：" + result.message);
                }
            },
            error: function (result) {
                alert(result.message);
            }
        });

    }

</script>
</body>

</html>
